<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <title>tj-unicom-iptv</title>
    <link rel="icon" href="data:,">
    <style>
        body {
            margin: 10px;
        }

        p {
            margin: 0;
            height: 24px;
        }

        a {
            text-decoration: none;
        }

        select {
            width: 192px;
        }

        #header p {
            margin-bottom: 10px;
        }
    </style>
    <script type="application/javascript" src="jquery.min.js"></script>
    <script type="application/javascript">
        let udpxy, state, videoHeight, xmlDoc;
        udpxy = 'http://192.168.6.1:5002/udp/';
        $(function () {
            $('#udpxy').val(udpxy);
            $.get('epg.xml?t=' + Date.now(), function (xml) {
                xmlDoc = xml;
                reload();
            });
        });

        function reload() {
            udpxy = $('#udpxy').val();
            state = [];
            videoHeight = [];
            $('input[name="c_state"]:checked').each(function () {
                state.push($(this).val())
            });
            $('input[name="c_height"]:checked').each(function () {
                videoHeight.push($(this).val())
            });
            $('#main').empty();
            let now = Date.now();
            let d = new Date(now);
            let hi = d.getHours().toString() + d.getMinutes().toString();
            hi = ~~hi;
            $.getJSON("iptv.json?t=" + now, function (data) {
                let tmp = [];
                $.each(data, function (key, value) {
                    let obj = {};
                    obj['id'] = key;
                    obj['sort'] = value['sort'];
                    obj['videoHeight'] = value['videoHeight'];
                    obj['state'] = value['state'];
                    tmp.push(obj);
                });
                tmp.sort(function (a, b) {
                    return a['sort'] - b['sort'];
                })
                /*
                tmp.sort(function (a, b) {
                    return b.videoHeight - a.videoHeight;
                })
                tmp.sort(function (a, b) {
                    return b.state - a.state;
                })
                */
                let m3u = "#EXTM3U\r\n";
                $.each(tmp, function (index, value) {
                    let id = value['id'];
                    if ($.inArray(data[id]['state'], state) === -1) {
                        return;
                    }
                    if ($.inArray(data[id]['videoHeight'].toString(), videoHeight) === -1) {
                        return;
                    }
                    let s, h;
                    if (data[id]['state'] === '1') {
                        s = ' checked="checked"';
                        h = '';
                        m3u += '#EXTINF:-1 ';
                        if(data[id]['tvg-name'] !== ''){
                            m3u += 'tvg-id="'+data[id]['tvg-name']+'" tvg-name="'+data[id]['tvg-name']+'" ';
                        }
                        m3u += 'group-title="'+data[id]['group-title']+'",'+data[id]['title']+"\r\n";
                        m3u += udpxy+data[id]['ip']+':'+data[id]['port']+"\r\n";
                    } else {
                        s = '';
                        h = ' checked="checked"';
                    }
                    let str = '<div style="margin: 10px;float: left; width: 200px; height: 340px;"><form id="f' + index + '">';
                    str += '<div style="height: 166px;">';
                    if (data[id]['videoHeight'] !== 0) {
                        str += '<a target="_blank" href="img/' + id + '.jpg">';
                        str += '<img alt="" style="width: 200px;" src="img/' + id + 's.jpg?s=' + now + '"/></a>';
                    }

                    let select = '<select style="width:200px;">';
                    if (data[id]['tvg-name'] !== '') {
                        $(xmlDoc).find("programme[channel=" + data[id]['tvg-name'] + "]").each(function () {
                            let start = $(this).attr('start').substring(8, 12);
                            let stop = $(this).attr('stop').substring(8, 12);
                            select += '<option';
                            if ((hi >= ~~start) && (hi < ~~stop)) {
                                select += ' selected';
                            }
                            select += '>' + start.substring(0, 2) + ':' + start.substring(2, 4);
                            select += ' ' + $(this).find('title').eq(0).text() + '</option>';
                        });
                    }
                    select += '</select>';
                    str += '</div>';
                    str += '<p><a href="' + udpxy + data[id]['ip'] + ':' + data[id]['port'] + '">';
                    str += data[id]['ip'] + ':' + data[id]['port'] + '</a> [' + data[id]['videoHeight'] + '] </p>';
                    str += '<p><input style="width:192px;" name="title" type="text" value="' + data[id]['title'] + '" readonly/></p>';
                    str += '<p><input style="width:192px;" name="tvg-name" type="text" value="' + data[id]['tvg-name'] + '" readonly/></p>';
                    str += '<p>' + select + '</p>';
                    str += '<p><input style="width:192px;" name="group-title" type="text" value="' + data[id]['group-title'] + '" readonly/></p>';
                    str += '<p><input style="width:192px;" name="sort" type="text" value="' + data[id]['sort'] + '" readonly/></p>';
                    str += '<p><input id="s_' + index + '" name="state" type="radio" value="1"' + s + ' disabled/><label for="s_' + index + '">显示</label>';
                    str += '<input id ="h_' + index + '" name="state" type="radio" value="0"' + h + ' disabled/><label for="h_' + index + '">隐藏</label></p>';
                    str += '</form></div>';
                    $('#main').append(str);
                });
                $('#m3u').html(m3u);
            });
        }
        </script>
</head>
<body>
<h1>天津联通IPTV频道整理</h1>
<h3>
    该页为GitHub项目的演示:</br>
    <a href="https://github.com/gabacai/tj-unicom-iptv">https://github.com/gabacai/tj-unicom-iptv</a></br>
    EPG文件来自:</br>
    <a href="https://epg.112114.xyz">https://epg.112114.xyz</a></br>
    <!--本地epg下载(<a href="epg.xml">epg.xml</a>)-->
</h3>
<div id="header">
    <p>
        <label for="udpxy">udpxy:</label>
        <input id="udpxy" type="text" value="" size="30"/>
    </p>
    <p>
        显示:
        <input id="c_state1" name="c_state" type="checkbox" checked="checked" value="1"/>
        <label for="c_state1">state=1</label>
        <input id="c_state0" name="c_state" type="checkbox" value="0"/>
        <label for="c_state0">state=0</label>
        <input id="c_height2160" name="c_height" type="checkbox" checked="checked" value="2160"/>
        <label for="c_height2160">height=2160</label>
        <input id="c_height1080" name="c_height" type="checkbox" checked="checked" value="1080"/>
        <label for="c_height1080">height=1080</label>
        <input id="c_height576" name="c_height" type="checkbox" value="576"/>
        <label for="c_height576">height=576</label>
        <input id="c_height0" name="c_height" type="checkbox" value="0"/>
        <label for="c_height0">height=0</label>
    </p>
       <div>
        m3u: <textarea id="m3u" rows="6" cols="40"></textarea>
    </div>
    <p></p><p>
        <a href="javascript:void(0);" onclick="reload();">刷新</a>
    </p>

</div>
<div id="main"></div>
</body>
</html>
